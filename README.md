# SyzGPT: Unlocking Low Frequency Syscalls in Kernel Fuzzing with Dependency-Based RAG

> We are still updating this project and formatting the documentations for Artifact Evaluation.

The implementation of the paper titled "Unlocking Low Frequency Syscalls in Kernel Fuzzing with Dependency-Based RAG". For more details about SyzGPT, please refer to [our paper]() from ISSTA'25.

SyzGPT is an LLM-assisted kernel fuzzing framework for automatically generating effective seeds for low frequency syscalls (LFS). Linux kernel provides over 360 system calls and Syzkaller defines more than 4400 specialized calls encapsulated for specific purposes of system calls. However, many of these syscalls (called LFS) are hard to be consistently covered due to the complex dependencies and mutation uncertainty, leaving the testing space. SyzGPT can automatically extract and augment syscall dependencies for these LFS and generate effective seeds with dependency-based RAG (DRAG).

**Project Structure**

```bash
.
├── analyzer/           # Corpus Analyzer
├── crawler/            # Crawler for Linux Manpages
├── data/               # Data used in SyzGPT
├── examples/           # Examples for better understanding
├── experiments/        # Experiments
├── extractor/          # Two-Level Syscall Dependency Extractor
├── fine-tune/          # Fine-tuning LLM specialized for Syz-programs
├── fuzzer/             # SyzGPT-fuzzer
├── generator/          # SyzGPT-generator
├── scripts/            # Some useful scripts
...
├── config.py           # Configs, need to be copied as private_config.py
├── syzgpt_generator.py # Main entry of SyzGPT-generator
```

## 1 Setup

### 1.1 Environment Requirements

- For running SyzGPT:
  - Machine with 16+ CPU cores, 64GB+ memory (For parallel fuzzing experiments)
  - Ubuntu 20.04 + (20.04 and 22.04 tested)
  - Syzkaller-runnable dependencies (setup according to Syzkaller project or use our docker)
  - Python 3.8+ (Python-3.8, 3.9, 3.10, 3.11 tested)
  - LLM API access or self-deployed LLM
- For kernel compilation:
  - Clang 15+ (15.0.6, 16.0.6, 17.0.6 tested)
  - GCC 11+ (11.4 and 12.2 tested)
- For LLM fine-tuning or serving:
  - GPU with 48GB+ (1 x A800, 2 x RTX 3090 tested)
  - torch 2.0+


### 1.2 Setup with Docker (Recommend)

We will release our docker image on dockerhub soon.

```bash
docker run -itd --name SyzGPT --privileged=true DOCKER_IMAGE
# You will find SyzGPT located at /root/SyzGPT
# And SyzGPT-fuzzer is located at /root/fuzzers/SyzGPT-fuzzer
```

### 1.3 Setup from scratch

You can also setup SyzGPT from scratch on a Ubuntu 20.04/22.04. Or base on our image [`qgrain/kernel-fuzz:v1`](https://hub.docker.com/repository/docker/qgrain/kernel-fuzz/general).

```bash
docker run -itd --name SyzGPT-from-scratch --privileged=true qgrain/kernel-fuzz:v1
```

1. Clone this project:

```bash
# Recommend at /root/SyzGPT, so that the following instructions can match with the path.
# If you are a normal user on a physical machine, feel free to clone it at a convenient place.
git clone https://github.com/QGrain/SyzGPT.git
```

2. Setup **SyzGPT-generator**: Please refer to Setup section in [generator/README.md](generator/README.md)

**SyzGPT-fuzzer**: Please refer to [fuzzer/README.md](fuzzer/README.md)


## 2 Usage

We have open-souced the augmented syscall depencies at [data/dependencies](data/dependencies/). So you can directly run SyzGPT without extract syscall dependency anymore.

You can also extract the syscall dependencies on your own, refer to **2.3 Extract and augment syscall dependency**.

### 2.1 Run SyzGPT for seed generation

We provide a simplest running instruction here. For detailed usage, please refer to [generator/README.md](generator/README.md).

```bash
# suppose you have: (1) a corpus.db generated by at least a 24-hour Syzkaller or some (2) the target syscall list
cd ~/SyzGPT/
python syzgpt_generator.py -s /root/fuzzers/SyzGPT-fuzzer -w WORKDIR -e /path/to/existing_corpus.db -f target_syscall_list.txt 
```

Explanation of Parameters (refer to [generator/README.md](generator/README.md) for more details):
- `-s`: path to the SyzGPT-fuzzer, must be specified.
- `-w`: output the generated results and logs to `WORKDIR`, must be specified.
- `-e`: path to external corpus, only nessary in one-time seed generation.
- `-f`: path to the file containing target syscall list, only needed in one-time seed generation.
- `-c`: you can also specify the target syscalls through `-c CALL1 CALL2 CALL3 ...` manually.

You will find the outputs in `WORKDIR` look like:

```bash
├── external_corpus/            # external corpus specified through -e
├── generated_corpus/           # generated seeds in Syz-program format
├── generation_history.json     # generation history for feedback-guided seed generation
├── query_prompts/              # generation logs including query prompts and results, which can be used for fine-tuning.
├── reverse_index.json          # reverse index for DRAG
└── target_syscalls/            # generation targets
```

### 2.2 Run SyzGPT for fuzzing

We provide a simplest running instruction here. For detailed usage, please refer to [generator/README.md](generator/README.md) and [fuzzer/README.md](fuzzer/README.md).

1. Run SyzGPT-fuzzer:

```bash
# cd the location where you setup SyzGPT-fuzzer
taskset -c 8-15 ./bin/syz-manager -config /root/SyzGPT/fuzzer/cfgdir/SyzGPT.cfg -bench benchdir/SyzGPT.log -statcall -backup 24h -enrich WORKDIR/generated_corpus -period 1h -repair
```

Explanation of Parameters (refer to [fuzzer/README.md](fuzzer/README.md) for more details):
- `-statcall`: enable syscall tracking during fuzzing.
- `-backup`: backup **rawcover**, **corpus.db**, **CoveredCalls**, and **crahes** every 24h.
- `-enrich`: load the enriched seeds from `WORKDIR/generated_corpus` every `INTERNAL` (1h).
- `-period`: `INTERVAL` of loading enriched seeds.
- `-repair`: enable program repair which is implemented in SyzGPT-fuzzer.

2. Run SyzGPT-generator:

```bash
# cd the root of this project
python syzgpt_generator.py -s /root/fuzzers/SyzGPT-fuzzer -w /root/fuzzers/SyzGPT-fuzzer/workdir/v6-1/SyzGPT/generated_corpus -D 1h -T 1h -S 24h -m 100 -P 10
```

Explanation of Parameters (refer to [generator/README.md](generator/README.md) for more details):
- `-s` and `-w` have been introduced above.
- `-D`: An empirical delay (1h) before generator start to work, which leave the fuzzer to explore by default.
- `-T`: generate seeds every `INTERVAL` (1h), need to be in the same pace with `-enrich` in fuzzer.
- `-S`: stop generating after 24h.
- `-m`: max generation amount, 100 here.
- `-P`: probability of feedback-guided re-generation for failed seeds, 10% here.

### 2.3 Extract syscall dependency

**Extract specialized call level dependency**:

We extract the specialized call level (syz-level) dependency through resource-based static analysis on Syzlangs.

1. Extract defined syscalls of the fuzzer:

```bash
# it will generate debug.log at ~/SyzGPT/data/debug.log and generate builtin_syscalls* at -o
cd extractor
python parse_builtin_syscalls.py -s ~/fuzzers/SyzGPT-fuzzer -o ../data/
```

2. Extract syz-level dependencies:

```bash
# it will generate syz-level dependencies at -o
python extract_syz_dependencies.py -b ../data/builtin_syscalls.json -o ../data/syz_dependencies
```

**Extract system call level dependency**:

1. Crawler the manpage documentation by syscalls:

```bash
# it will download the docs at crawler/man_docs/SYSCALL.json
cd crawler
python get_syscall_doc.py
```

2. Extract call-level dependencies:

```bash
# -d for dumb mode, recommended
cd extractor
python extract_call_dependencies.py -f ../crawler/syscall_from_manpage.txt -d
```

### 2.4 Use some intersting tools developed in SyzGPT

To be updated with details. You may look around at `scripts/` first.

**1. diff_config.py**: diff two kernel configurations with rich printing.
- Usage: `python diff_config.py <config1_path> <config2_path>`

**2. result_parser.py**: visualize the fuzzing crashes with de-duplication.
- Usage: `python result_parser.py -D WORKDIR1 WORKDIR2 ... -c -u -e SYZFATAL SYZFAIL`

**3. build_llvm-project.sh**: automatically build llvm-project with specified version.
- Usage: `./build_llvm-project.sh <VERSION> (e.g., 15.0.6)`

**4. collect_repro.py**: collect reproducers from Syzbot (as syzbot limit the requests in 1 per second, we need to rewrite this script)
- Usage: `python collect_repro.py`

## 3 Fine-tuning LLM for Syz-programs

Please refer to [fine-tune/README.md](fine-tune/README.md)

## 4 Reusability

Our approach is able to be migrated to other kernel fuzzing framework, such as Syzkaller-like (ACTOR, ECG, KernelGPT, ...) and Healer-like (Healer and MOCK) fuzzers.

### 4.1 Migrate to Syzkaller-like fuzzers

We have demonstrated the migration on KernelGPT, please refer to the implementation instruction in [experiments/KernelGPT/README.md](experiments/KernelGPT/README.md).

### 4.2 Migrate to Healer-like fuzzers

Simple as migrating to Syzkaller-like, as long as you are familiar with RUST.

We also prepare a instruction for migrating to MOCK, please refer to the implementation instruction in [experiments/MOCK/README.md](experiments/MOCK/README.md).

## 5 For Paper Review

To better understand our work, you can refer to [README_for_review.md](./README_for_review.md).