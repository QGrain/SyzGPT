# SyzGPT-generator

We have open-souced the augmented syscall depencies at [../data/dependencies](../data/dependencies/). So you can directly run SyzGPT without extract syscall dependency anymore.

You can also extract the syscall dependencies on your own, please refer to [../extractor/README.md](../extractor/README.md).

## 1 Setup

1. Install dependencies:

```bash
# The dependencies have been included in a virtual python env, which is entered by 'workon syzgpt'
cd ~/SyzGPT
pip install -r requirements.txt
```

2. Config API_KEY in **private_config.py** (Call-level dependency extraction will use LLM)

```bash
# for security concern
cp config.py private_config.py
# and then edit API_KEY in private_config.py
```

## 2 Usage

### 2.1 One-time seed generation

Prerequisites: 
- A corpus generated by at local Syzkaller or some other existing fuzzers, which can serve as the corpus knowledge base. We provide a `corpus_24h.db` at [data/corpus_24h.db](./data/corpus_24h.db) for reproduction.

```bash
# e.g., you can also use a richer corpus as program knowledge base (passed by argument '-e')
mkdir /root/corpus && cd /root/corpus
wget https://github.com/cmu-pasta/linux-kernel-enriched-corpus/releases/download/latest/enriched-ci-qemu-upstream-corpus.db
```

- A file containing target syscalls for which you want to generate seeds. We provide a `sampled_variants.txt` at [data/sampled_variants.txt](./data/sampled_variants.txt) for reproduction.

```bash
# cd the root of this project, e.g., /root/SyzGPT

# (1) Use official OpenAI api (it will load api_key, llm_model, ... from private_config.py)
python syzgpt_generator.py -s /root/fuzzers/SyzGPT-fuzzer -w WORKDIR -e data/corpus_24h.db -f sampled_variants.txt

# (2) Use third party api
python syzgpt_generator.py -M gpt-3.5-turbo-16k -u https://api.expansion.chat/v1/ -k API_KEY -s /root/fuzzers/SyzGPT-fuzzer -w WORKDIR -e data/corpus_24h.db -f sampled_variants.txt

# (3) Use local LLMs
python syzgpt_generator.py -M CodeLlama-syz-toy -u http://IP:PORT/v1/ -s /root/fuzzers/SyzGPT-fuzzer -w WORKDIR -e data/corpus_24h.db -f sampled_variants.txt
```

Explanation of Parameters:
- `-s`: path to the SyzGPT-fuzzer, must be specified.
- `-w`: output the generated results and logs to `WORKDIR`, must be specified.
- `-e`: path to external corpus, only nessary in one-time seed generation.
- `-f`: path to the file containing target syscall list, only needed in one-time seed generation.
- `-c`: you can also specify the target syscalls through `-c CALL1 CALL2 ...` manually, instead of `-f`.
- `-M`: model name, used with third party api or local LLM.
- `-u`: base_url to api address or local hosted LLM.
- `-k`: api_key for third party api service.

You will find the outputs in `WORKDIR` look like:

```bash
├── external_corpus/          # external corpus specified through -e
├── generated_corpus/         # generated seeds in Syz-program format
├── generation_history.json   # generation history for feedback-guided seed generation
├── query_prompts/            # generation logs including query prompts and results, can be used for fine-tuning.
├── reverse_index.json        # reverse index for DRAG
└── target_syscalls/          # generation targets
```

### 2.2 Continuous seed generation (for fuzzing)


#### Step 1: Run SyzGPT-fuzzer:

```bash
# cd the location where you setup SyzGPT-fuzzer
taskset -c 8-15 ./bin/syz-manager -config /root/SyzGPT/fuzzer/cfgdir/SyzGPT.cfg -bench benchdir/SyzGPT.log -statcall -backup 24h -enrich WORKDIR/generated_corpus -period 1h -repair
```

Explanation of Parameters (refer to [fuzzer/README.md](fuzzer/README.md) for more details):
- `-statcall`: enable syscall tracking during fuzzing.
- `-backup`: backup **rawcover**, **corpus.db**, **CoveredCalls**, and **crahes** every 24h.
- `-enrich`: load the enriched seeds from `WORKDIR/generated_corpus` every `INTERNAL` (1h).
- `-period`: `INTERVAL` of loading enriched seeds.
- `-repair`: enable program repair which is implemented in SyzGPT-fuzzer.

#### Step 2: Run SyzGPT-generator:

```bash
# cd the root of this project
python syzgpt_generator.py -s /root/fuzzers/SyzGPT-fuzzer -w /root/fuzzers/SyzGPT-fuzzer/workdir/v6-1/SyzGPT/generated_corpus -D 1h -T 1h -S 24h -m 100 -P 10
# seemingly, you can also use other api service
# or local hosted LLM with -M, -u, -k (introduced in section 2.1)
```

Explanation of Parameters:
- `-s` and `-w` have been introduced above.
- `-D`: an empirical delay (1h) before generator start to work, which leave the fuzzer to explore by default.
- `-T`: generate seeds every `INTERVAL` (1h), need to be in the same pace with `-enrich` in fuzzer.
- `-S`: stop generating after 24h.
- `-m`: max generation amount, 100 here.
- `-P`: probability of feedback-guided re-generation for failed seeds, 10% here.

#### Step 3: Evaluate the generation

```bash
# 1. Evaluate the Syntax Valid Rate (SVR)
/root/fuzzers/SyzGPT-fuzzer/bin/syz-validator dir WORKDIR/generated_corpus

# 2. Evaluate the Syntax Valid Rate (SVR) after repair
/root/fuzzers/SyzGPT-fuzzer/bin/syz-validator dir WORKDIR/generated_corpus_repair

# 3. Evaluate the N_avg and L_avg
/root/fuzzers/SyzGPT-fuzzer/bin/syz-validator dir WORKDIR/generated_corpus_repair WORKDIR/generated_corpus_repair_valid
python /root/SyzGPT/analyzer/corpus_analyzer.py analyze -d WORKDIR/generated_corpus_repair_valid

# 4. Evaluate the Context Effective Rate (CER)
cp -r WORKDIR/generated_corpus_repair_valid WORKDIR/generated_corpus_repair_valid_rev
python /root/SyzGPT/experiments/performance/reverse_prog.py WORKDIR/generated_corpus_repair_valid_rev
syzqemuctl create image-eval
syzqemuctl run image-eval
syzqemuctl exec image-eval "mkdir /root/evaluate_cer"
syzqemuctl cp WORKDIR/generated_corpus_repair_valid_rev image-eval:/root/evaluate_cer/
syzqemuctl cp /root/fuzzers/SyzGPT-fuzzer/bin/linux_amd64/syz-execprog image-eval:/root/
syzqemuctl cp /root/fuzzers/SyzGPT-fuzzer/bin/linux_amd64/syz-executor image-eval:/root/
syzqemuctl exec image-eval "/root/syz-execprog -semantic -progdir /root/evaluate_cer/generated_corpus_repair_valid_rev -coverfile /root/evaluate_cer/out/CER"
syzqemuctl cp image-eval:/root/evaluate_cer/CER_Evaluation_Results ./
# It's a bit complicated, recommend to use our all-in-one script `experiments/performance/evaluate.py`
```

> [!NOTE] 
> You can run the all-in-one script to reproduce the seed generation experiments in paper Table 2.

```bash
python /root/SyzGPT/experiments/performance/evaluate.py -i /root/images -n image-eval -k /root/kernels/linux-6.6.12 -s /root/fuzzers/SyzGPT-fuzzer -w WORKDIR
# The evaluation results are written to WORKDIR/evaluate.log
```